<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>JSON Chat - Websockets</title>
</head>
<body onload="init()">
<div id="messages" style="height: 200px; overflow: auto;"></div>
<hr>
<b id="client-count"></b>
<hr>
<input id="message">
<button onclick="send()">Send</button>

<script>
    var username = null;
    var websocket = null;

    function init() {
        while (username == null || username.trim() === "") {
            username = prompt("Enter username");
        }

        websocket = new WebSocket(`ws://localhost:8080/json/chat/${username}`);

        websocket.onopen = function(resp) {
            console.log("onopen", resp);
        };

        websocket.onmessage = function(resp) {
            var msg = JSON.parse(resp.data);
            var output = document.getElementById('messages');
            output.insertAdjacentHTML("beforeend", `<p><b>${msg.sender}</b>: ${msg.text}</p>`);
            output.scrollTop = output.scrollHeight;

            if (msg.type !== 2) {
                document.getElementById('client-count').innerText = `Chatters: ${msg.count}`;
            }
        };

        websocket.onerror = function(resp) {
            alert('An error occurred, closing application');
            console.error("onerror", resp);
        };

        websocket.onclose = function(resp) {
            alert(resp.reason || 'Goodbye');
            console.log("onclose", resp);
        };
    }

    function send() {
        var input = document.getElementById("message");
        var msg = { sender: username, text: input.value, type: 2 };
        websocket.send(JSON.stringify(msg));
        input.value = '';
    }
</script>
</body>
</html>
